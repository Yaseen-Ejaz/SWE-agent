#!/usr/bin/env python3
# view_image â€“ view an image file as a base64-encoded markdown image
import base64
import mimetypes
import pathlib
import sys
from PIL import Image
import io

VALID_MIME_TYPES = {
    "image/png",
    "image/jpeg",
    "image/webp",
}

if len(sys.argv) < 2 or len(sys.argv) > 3:
    sys.exit(f"usage: {pathlib.Path(sys.argv[0]).name} <image-file> [--grayscale]")

img_path = pathlib.Path(sys.argv[1])
grayscale = len(sys.argv) == 3 and sys.argv[2] == "--grayscale"

if not img_path.exists():
    sys.exit(f"Error: File '{img_path}' does not exist")

if not img_path.is_file():
    sys.exit(f"Error: '{img_path}' is not a file")

try:
    mime = mimetypes.guess_type(img_path.name)[0]
    if mime not in VALID_MIME_TYPES:
        sys.exit(f"Error: Unsupported image type: {mime}. Valid types are: {', '.join(VALID_MIME_TYPES)}")
    
    #grayscale conversion
    if grayscale:
        #use pil and convert to grayscale
        img = Image.open(img_path).convert("L")
        
        
        buffer = io.BytesIO()
        img_format = img_path.suffix[1:].upper()
        if img_format == "JPG":
            img_format = "JPEG"
        img.save(buffer, format=img_format)
        
        b64 = base64.b64encode(buffer.getvalue()).decode("ascii")
    else:
        b64 = base64.b64encode(img_path.read_bytes()).decode("ascii")

    # write the exact markdown snippet to stdout
    print(f"![{img_path.as_posix()}](data:{mime};base64,{b64})")
except Exception as e:
    sys.exit(f"Error processing image: {e}")